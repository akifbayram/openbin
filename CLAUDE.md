# OpenBin

## Project Overview

Multi-user web app for organizing physical storage bins with QR codes. Data persists in SQLite via Express API. Liquid Glass design system.

**Core flows**: Register/login -> Create/join location -> Create bin -> Print QR label -> Scan to find contents.

## Architecture

- **Client**: React 18 + TypeScript 5 (strict) + Vite 5, Tailwind CSS 4, react-router-dom 6 (BrowserRouter)
- **Server**: Express 4, SQLite (better-sqlite3), JWT auth, express-rate-limit
- **Docker**: Single container (Express serves static frontend + API), reverse proxy optional
- Features live in `src/features/`, server code in `server/src/`, shared types in @src/types.ts
- **No component library** — all UI primitives hand-rolled in `src/components/ui/`. NEVER run `npx shadcn`; build components in `src/components/ui/` instead.

## Code Conventions

- **Git commits**: NEVER add "Co-Authored-By" or AI attribution lines.
- **Named exports only** — ALWAYS use named exports. No default exports except `App.tsx`.
- **Feature hooks pattern**: each feature exposes a hook (e.g. `useBinList`) for data via `apiFetch()` with event-based refresh (`bins-changed` DOM events), and plain async functions (e.g. `addBin`) for mutations. Same file.
- **Data hooks return `{ data, isLoading }`** — e.g. `useBinList()` → `{ bins, isLoading }`.
- **`apiFetch<T>(path, options)`** in `lib/api.ts` — wraps fetch with JWT (httpOnly cookies), auto JSON, FormData support. Throws `ApiError`. Optional `skipRefresh: true` prevents auto-refresh on 401.
- **`useAuth()`** in `lib/auth.tsx` — `user`, `token`, `activeLocationId`, `login()`, `register()`, `logout()`, `setActiveLocationId()`, `updateUser()`, `deleteAccount()`.
- **`LocationProvider`** in `features/locations/useLocations.tsx` — context provider for location data. `useLocationList()` must be rendered within it. Also used by `useAppSettings()`.
- **`useAppSettings()`** in `lib/appSettings.ts` — location-specific customization (app name, terminology). Returns `{ settings, updateSettings, resetSettings, isLoading }`. Debounces API saves (500ms).
- **Soft deletes**: `DELETE /api/bins/:id` sets `deleted_at`. All bin queries filter `WHERE deleted_at IS NULL`.
- **API response envelopes**: Lists return `{ results: T[], count }`. Errors return `{ error: "CODE", message }` with codes: `UNAUTHORIZED` (401), `VALIDATION_ERROR` (422), `NOT_FOUND` (404), `FORBIDDEN` (403), `CONFLICT` (409), `INTERNAL_ERROR` (500). Exception: `GET /api/locations/:locationId/areas` returns `{ results, count, unassigned_count }`. `Location` and `Area` types include `bin_count`.
- **CSS**: use `var(--token)` design tokens, not raw colors. Glass effects via `glass-card`, `glass-nav`, `glass-heavy`.
- **Responsive**: mobile-first. Breakpoint `lg` (1024px) — bottom nav on mobile, sidebar on desktop.
- **`addBin()`** takes `{ name, locationId, items?, notes?, tags?, areaId?, icon?, color?, visibility? }`. Short code auto-generated by server from the bin name.
- **Server error handling**: Routes use `throw new ValidationError(...)` etc. from `server/src/lib/httpErrors.ts`, wrapped in `asyncHandler()` from `server/src/lib/asyncHandler.ts` to forward to the global error handler.
- **Biome linter**: `biome.json` at repo root — recommended rules, formatter disabled, scoped to `src/**`. No ESLint or Prettier.
- **Event bus**: `notify()` and `useRefreshOn()` from `lib/eventBus.ts`. 7 event types: `BINS`, `LOCATIONS`, `PHOTOS`, `PINS`, `AREAS`, `TAG_COLORS`, `SCAN_HISTORY`.

## API Documentation

OpenAPI spec at `server/openapi.yaml` (source of truth). Update when endpoints change, then copy to `public/api-docs/openapi.yaml`.

## Gotchas

- **Theme**: `localStorage('openbin-theme')`, applied via `<html class="dark|light">` before first paint. `useTheme()` in `lib/theme.ts` is runtime source of truth.
- **ISO date strings**: All date fields are `string`, not `Date`. SQLite stores as TEXT.
- **`html5-qrcode`** is ~330KB gzipped — always dynamic-import the scanner page.
- **Photos served via API**: `getPhotoUrl(id)` → `/api/photos/${id}/file`. Auth via httpOnly cookies (no query param).
- **BrowserRouter**: path-based URLs. QR scanner regex handles both old hash and new path URLs.
- **Env var reference**: See @.env.example for all env vars (backup, auth, AI, uploads, rate limiting).
- **Route mounting**: Photos upload on bins router (`POST /api/bins/:id/photos`). Export at `/api`. Areas at `/api/locations`.
- **Server config**: All env vars parsed and validated in `server/src/lib/config.ts` with safe defaults. See `.env.example` for the full list.

## Security (non-obvious)

- **JWT secret** auto-generated and persisted to `/data/.jwt_secret` if `JWT_SECRET` env var unset.
- **AI API key encryption**: AES-256-GCM when `AI_ENCRYPTION_KEY` env var set. Graceful fallback to plaintext.
- **Dual auth**: Middleware supports JWT tokens and API keys (`sk_openbin_` prefix). `req.authMethod` is `'jwt' | 'api_key'`.

## Verification

```sh
npx tsc --noEmit              # Frontend type check
npx vitest run                # Tests (happy-dom, not jsdom)
npx vite build                # Production build
cd server && npx tsc --noEmit # Server type check
docker compose up -d          # Full stack
```

- ALWAYS run `npx tsc --noEmit` after code changes. Run `npx vitest run path/to/test` for targeted tests over the full suite.
- When compacting context, preserve the full list of modified files and any failing test output.

## Testing

- Vitest 4 + happy-dom. Tests mock `apiFetch` from `@/lib/api` and `useAuth` from `@/lib/auth`.
- Test files in `__tests__/` directories next to feature code.
